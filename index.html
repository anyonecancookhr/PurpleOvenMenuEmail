<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purple Oven</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- Flatpickr (Date Picker) CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- REQUIRED: EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --purple-oven: #5D3FD3;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
        }
        .text-purple-oven {
            color: var(--purple-oven);
        }
        .bg-purple-oven {
            background-color: var(--purple-oven);
        }
        /* Custom scrollbar */
        .menu-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .menu-scroll::-webkit-scrollbar-thumb {
            background-color: #e0e0e0;
            border-radius: 4px;
        }
        /* Responsive form grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1rem;
        }
        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        /* Animations */
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .location-link {
            transition: all 0.15s ease-in-out;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
        }
        .location-link:hover {
            background-color: rgba(93, 63, 211, 0.1);
        }
        /* Collapsible icon styling */
        details[open] > summary .summary-icon {
            transform: rotate(180deg);
        }
        .summary-icon {
            transition: transform 0.3s ease;
        }
        .nested-summary {
            padding-left: 0.75rem;
        }
        /* Custom Notice Box */
        .notice-box {
            background-color: #FAF5FF;
            border: 1px solid #E9D5FF;
            border-radius: 0.75rem;
        }
        .option-box {
            background-color: #F3E8FF;
            border-radius: 0.5rem;
        }
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Checkbox custom style */
        input[type="checkbox"]:checked {
            background-color: var(--purple-oven);
            border-color: var(--purple-oven);
        }
        /* Details Summary Styles */
        details summary {
            list-style: none;
        }
        details summary::-webkit-details-marker {
            display: none;
        }
        /* Flatpickr Customization */
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: #5D3FD3;
            border-color: #5D3FD3;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="main-content flex flex-col items-center p-4 sm:p-8">
        <!-- Content injected by JS -->
    </div>

    <footer class="bg-gray-100 py-10 px-4 w-full border-t border-gray-200">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col md:flex-row gap-10">
                <!-- Left Side: Locations -->
                <div class="md:w-2/3">
                    <h3 class="text-xl font-bold mb-6 text-purple-oven flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Locations & Hours
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 text-sm">
                        <div>
                            <p class="font-bold text-gray-800 mb-2 border-b border-gray-300 pb-1">Metro Manila 8AM – 9PM</p>
                            <div class="space-y-3">
                                <div>
                                    <p class="font-semibold text-purple-oven">Pasig</p>
                                    <ul class="ml-2 space-y-1">
                                        <li>- <a href="https://www.google.com/maps/search/Purple+Oven+Pasig" target="_blank" class="hover:underline">Portico</a></li>
                                    </ul>
                                </div>
                                <div>
                                    <p class="font-semibold text-purple-oven">Makati</p>
                                    <ul class="ml-2 space-y-1">
                                        <li>- <a href="https://www.google.com/maps/search/Purple+Oven+San+Antonio" target="_blank" class="hover:underline">San Antonio Plaza Arcade</a></li>
                                        <li>- <a href="https://www.google.com/maps/search/Purple+Oven+Legazpi+Village" target="_blank" class="hover:underline">Legaspi Street</a></li>
                                        <li>- <a href="https://www.google.com/maps/search/Purple+Oven+Sacred+Heart" target="_blank" class="hover:underline">Sacred Heart Street</a></li>
                                    </ul>
                                </div>
                                <div>
                                    <p class="font-semibold text-purple-oven">Quezon City</p>
                                    <ul class="ml-2 space-y-1">
                                        <li>- <a href="https://www.google.com/maps/search/Purple+Oven+Temple+Drive" target="_blank" class="hover:underline">Temple Drive</a></li>
                                        <li>- <a href="https://www.google.com/maps/search/Purple+Oven+Scout+Rallos" target="_blank" class="hover:underline">Scout Rallos</a></li>
                                    </ul>
                                </div>
                                <div>
                                    <p class="font-semibold text-purple-oven">Alabang</p>
                                    <ul class="ml-2 space-y-1">
                                        <li>- <a href="https://www.google.com/maps/search/Purple+Oven+Alabang" target="_blank" class="hover:underline">Alabang Town Center</a></li>
                                    </ul>
                                </div>
                                <div>
                                    <p class="font-semibold text-purple-oven">San Juan</p>
                                    <ul class="ml-2 space-y-1">
                                        <li>- <a href="https://www.google.com/maps/search/Purple+Oven+San+Juan" target="_blank" class="hover:underline">Santolan Town Plaza</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 mb-2 border-b border-gray-300 pb-1">Laguna 9AM – 9PM</p>
                            <div class="space-y-3">
                                <ul class="ml-2 space-y-1">
                                    <li>- <a href="https://www.google.com/maps/search/Purple+Oven+Santa+Rosa+Laguna" target="_blank" class="hover:underline">Santa Rosa</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side: Contact -->
                <div class="md:w-1/3 md:border-l md:border-gray-300 md:pl-10">
                    <h3 class="text-xl font-bold mb-6 text-purple-oven flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Contact Us
                    </h3>
                    <p class="text-sm text-gray-500 mb-6 font-medium">9AM to 6PM</p>
                    
                    <div class="space-y-4">
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 uppercase tracking-wide font-semibold mb-1">Landline</span>
                            <a href="tel:+63286314221" class="text-lg text-purple-oven font-bold hover:bg-purple-50 p-2 rounded-lg transition-colors inline-block border border-transparent hover:border-purple-100">
                                +632 8631 4221
                            </a>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 uppercase tracking-wide font-semibold mb-1">Viber / Mobile</span>
                            <a href="tel:+639177103227" class="text-lg text-purple-oven font-bold hover:bg-purple-50 p-2 rounded-lg transition-colors inline-block border border-transparent hover:border-purple-100">
                                +63917 710 3227
                            </a>
                        </div>
                        <div class="flex flex-col pt-2">
                            <span class="text-xs text-gray-500 uppercase tracking-wide font-semibold mb-1">Email</span>
                            <a href="mailto:orderonline@purpleoven.com.ph" class="text-base text-gray-700 font-medium hover:text-purple-oven break-all hover:underline">
                                orderonline@purpleoven.com.ph
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-10 text-center text-xs text-gray-500 border-t pt-6">
                © 2025 Purple Oven. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // --- Global State and Constants ---
        const APP_ROOT = document.getElementById('app');
        
        // --- GITHUB IMAGE REFERENCES ---
        // Ensure 'purple_oven.png' and 'PO_Menu-images-0.jpg' etc. are in the SAME repo folder as this index.html
        const PO_LOGO_URL = "purple_oven.png";
        
        // --- EMAILJS CONFIGURATION ---
        const EMAILJS_PUBLIC_KEY = "zipf8D6huE9iUliyx"; 
        const EMAILJS_SERVICE_ID = "service_ovc10mr";
        const EMAILJS_TEMPLATE_ID = "template_99fgo0t";

        // Initialize EmailJS
        (function() {
            if(EMAILJS_PUBLIC_KEY && window.emailjs){
                emailjs.init(EMAILJS_PUBLIC_KEY);
            }
        })();
        
        let state = {
            view: 'landing', 
            selectedBrand: 'PurpleOven',
            lastSubmittedFormData: null,
            isSubmitting: false,
            lastOrderDetails: null // New property to store final order details
        };

        // --- MENU DATA ---
        const purpleOvenMenuData = [
            {
                category: "Cakes",
                subCategories: [
                    {
                        name: "Light Cakes (8 In)",
                        items: [
                            { name: "Honeycomb Crunch Cake - whole" },
                            { name: "Pistachio Stardust - whole" },
                            { name: "Chocolate Honeycomb Crunch Cake - whole" },
                            { name: "Strawberry Kisses - whole" }
                        ]
                    },
                    {
                        name: "Cakes with Nutty Layers (8 In)",
                        items: [
                            { name: "Classic Sans Rival - whole" },
                            { name: "Dark Mocha Sans Rival - whole" },
                            { name: "White Chocolate Sans Rival - whole" },
                            { name: "Rustic Chocolate Torte - whole" },
                            { name: "Merry Cherry Torte - whole" },
                            { name: "Mango Walnut Torte - whole" },
                            { name: "Lemon Torte - whole" }
                        ]
                    },
                    {
                        name: "Chocolate Cakes (8 In)",
                        items: [
                            { name: "Grandma’s Chocolate Cake - whole" },
                            { name: "Chocolate Dome Cake - whole" },
                            { name: "Chocolate Campfire - whole" },
                            { name: "Classic Chocolate Cake - whole" },
                            { name: "Caramel Sauce - whole" }
                        ]
                    },
                    {
                        name: "Cheesecakes (8 In)",
                        items: [
                            { name: "New York Cheesecake - whole" },
                            { name: "Blueberry Cheesecake - whole" },
                            { name: "Oreo Cheesecake - whole" }
                        ]
                    },
                    {
                        name: "Tub Desserts (8x14 In)",
                        items: [
                            { name: "Tiramisu - whole" },
                            { name: "Strawberries and Cream - whole" }
                        ]
                    },
                    {
                        name: "Pies (9 In)",
                        items: [
                            { name: "Apple Crumb Pie - whole" },
                            { name: "Banoffee Pie - whole" }
                        ]
                    },
                    {
                        name: "Little Cakes and Pies",
                        items: [
                            { name: "Little Carrot Cake - pc" },
                            { name: "Chocolate Lava Cake - pc" },
                            { name: "Little Banoffee Pie - pc" },
                            { name: "Little Apple Crumb Pie - pc" },
                            { name: "Little Pecan Pie - pc" }
                        ]
                    }
                ]
            },
            {
                category: "Bars",
                subCategories: [
                    {
                        name: "",
                        items: [
                            { name: "Mango Bars Half - 16pc" },
                            { name: "Mango Bars Whole - 32pc" },
                            { name: "Lemon Bars Half - 16pc" },
                            { name: "Lemon Bars Whole - 32pc" },
                            { name: "Double Chocolate Brownies Half - 16pc" },
                            { name: "Double Chocolate Brownies Whole - 32pc" },
                            { name: "Fudge Brownies Half - 16pc" },
                            { name: "Fudge Brownies Whole - 32pc" },
                            { name: "Food for the Gods Half - 16pc" },
                            { name: "Food for the Gods Whole - 32pc" },
                            { name: "Chocolate Revel Bars Half - 16pc" },
                            { name: "Chocolate Revel Bars Whole - 32pc" }
                        ]
                    }
                ]
            },
            {
                category: "Cookies",
                subCategories: [
                    {
                        name: "",
                        items: [
                            { name: "Chocolate Macadamia Cookie - pc" },
                            { name: "White Chocolate Cashew Cookie - pc" },
                            { name: "Chocolate Dipped Cookie - pc" },
                            { name: "Double Chocolate Chip Cookie - pc" },
                            { name: "Reese’s Peanut Butter Chip Cookie - pc" },
                            { name: "White Chunk Chocolate Cookie - pc" },
                            { name: "Oatmeal Raisin Cookie - pc" },
                            { name: "Chocolate Crinkles - box of 12" }
                        ]
                    }
                ]
            },
            {
                category: "Loaves",
                subCategories: [
                    {
                        name: "",
                        items: [
                            { name: "Banana Loaf - loaf" },
                            { name: "Carrot Walnut Loaf - loaf" },
                            { name: "Orange Almond Loaf - loaf" },
                            { name: "Pistachio Lime Loaf - loaf" },
                            { name: "Chocolate Banana Walnut Loaf - loaf" }
                        ]
                    }
                ]
            },
            {
                category: "Snack Packs",
                subCategories: [
                    {
                        name: "",
                        items: [
                            { name: "Chocolate Carousel - pack" },
                            { name: "Purple Crumble - pack" }
                            ]
                    }
                ]
            },
            {
                category: "Bread and Pastries",
                subCategories: [
                    {
                        name: "Quiches",
                        items: [
                            { name: "Broccoli and Cheese Quiche - pc" },
                            { name: "Quiche Lorraine - pc" }
                        ]
                    },
                    {
                        name: "Flaky Pastries",
                        items: [
                            { name: "Chicken Curry Turnover - pc" },
                            { name: "Chili con Carne Turnover - pc" },
                            { name: "Chorizo Roll - pc" },
                            { name: "Sausage Puff - pc" },
                            { name: "Spinach Danish - pc" },
                            { name: "Tuna Turnover - pc" }
                        ]
                    },
                    {
                        name: "Soft Savory Buns",
                        items: [
                            { name: "Adobo Flakes Bun - pc" },
                            { name: "Pork Asado Bun - pc" },
                            { name: "Corned Beef Bun - pc" },
                            { name: "Tuna Bun - pc" },
                            { name: "Ham and Cheese Bun - pc" },
                            { name: "Sausage Bun - pc" }
                        ]
                    },
                    {
                        name: "Croissants",
                        items: [
                            { name: "Butter Croissant - pc" },
                            { name: "Ham and Cheese Croissant - pc" },
                            { name: "Chocolate Croissant - pc" }
                        ]
                    },
                    {
                        name: "Sweet Breads",
                        items: [
                            { name: "Cheese Roll - pc" },
                            { name: "Ensaymada - pc" },
                            { name: "Soft Cinnamon Roll - pc" }
                        ]
                    },
                    {
                        name: "Artisan Breads",
                        items: [
                            { name: "Cinnamon Raisin Pretzel - pc" },
                            { name: "Parmesan Pretzel - pc" },
                            { name: "Sourdough - loaf" },
                            { name: "Raisin Bread - loaf" }
                        ]
                    }
                ]
            },
            {
                category: "Reusable Bag",
                subCategories: [
                    {
                        name: "",
                        items: [
                            { name: "Large Bag - pc" },
                            { name: "Small Bag - pc" }
                        ]
                    }
                ]
            }
        ];

        const brands = {
            PurpleOven: {
                theme: 'purple-white',
                description: ``,
                logo: PO_LOGO_URL,
                menuFiles: Array.from({ length: 10 }, (_, i) => `PO_Menu-images-${i}.jpg`)
            }
        };
        
        const timeSlots = Array.from({ length: 11 }, (_, i) => `${(i + 9) % 12 === 0 ? 12 : (i + 9) % 12} ${i + 9 < 12 ? 'AM' : 'PM'}`).slice(0, 11); 
        
        const pickUpLocations = [
            'Pasig - Portico',
            'Makati - San Antonio Plaza Arcade',
            'Makati - Legaspi Street',
            'Makati - Sacred Heart Street',
            'Quezon City - Temple Drive',
            'Quezon City - Scout Rallos',
            'Alabang - Alabang Town Center',
            'San Juan - Santolan Town Plaza',
            'Laguna - Santa Rosa'
        ];
        
        // --- View Navigation ---

        function showLanding() {
            state.view = 'landing';
            state.selectedBrand = 'PurpleOven';
            render();
            window.scrollTo(0,0);
        }

        function showMenu(brand) {
            state.view = 'menu';
            state.selectedBrand = brand;
            render();
            window.scrollTo(0,0);
        }

        function showOrder() {
            state.view = 'order_form';
            // Clear last form data when starting a new order
            state.lastSubmittedFormData = null; 
            render();
            window.scrollTo(0,0);
        }

        function showSuccess() {
            state.view = 'success';
            render();
            window.scrollTo(0,0);
        }

        // --- HTML Rendering ---

        function renderLanding() {
            APP_ROOT.classList.add('justify-center');
            return `
                <div class="text-center animate-fadeIn w-full max-w-2xl flex flex-col items-center">
                    <img src="${PO_LOGO_URL}" onerror="this.src='https://placehold.co/300x100/5D3FD3/fff?text=Purple+Oven'"
                        alt="Purple Oven Logo" class="mx-auto mb-6 h-auto max-h-[200px] w-auto object-contain">
                    
                    <p class="text-xl text-gray-600 mb-10 max-w-xl leading-relaxed">
                         At Purple Oven, we bake<br>
                         all day everyday with<br>
                         real eggs, cream, and butter.<br>
                         And we serve them while<br>
                         they’re at their best.<br>
                         It makes us happy to<br>
                         have you bring home<br>
                         the freshest and finest<br>
                         products we can offer.
                    </p>

                    <button onclick="showMenu('PurpleOven')"
                            class="px-10 py-4 text-lg font-semibold text-white rounded-full transition duration-300 shadow-lg bg-purple-oven hover:bg-indigo-700 transform hover:scale-105">
                        See Our Menu
                    </button>
                </div>
            `;
        }

        function renderMenu(brand) {
            APP_ROOT.classList.remove('justify-center');
            const data = brands[brand];
            const themeClass = 'text-purple-oven border-purple-oven';
            const buttonClass = 'bg-purple-oven hover:bg-indigo-700';

            const menuContent = `
                <div class="flex justify-center items-center mb-6">
                    <img src="${data.logo}"
                            onerror="this.src='https://placehold.co/80x80/5D3FD3/fff?text=${brand}'"
                            alt="${brand} Logo" class="h-20 w-20 object-contain mx-auto">
                </div>

                <div class="h-[calc(100vh-280px)] max-h-[80vh] w-full border ${themeClass} rounded-xl overflow-y-auto menu-scroll shadow-inner bg-gray-50">
                    <div class="space-y-4 p-2">
                        ${data.menuFiles.map(file => `
                            <img src="${file}" 
                                 alt="Menu Page" 
                                 class="w-full h-auto object-contain rounded-lg shadow-sm border border-gray-100 min-h-[200px] bg-gray-50"
                                 onerror="this.onerror=null; this.src='https://placehold.co/600x800/f3f4f6/9ca3af?text=Image+Not+Found:\\n${file}'; this.style.objectFit='contain';">
                        `).join('')}
                    </div>
                </div>
                
                <div class="mt-8 flex justify-between items-center">
                    <button onclick="showLanding()" class="text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 rounded-md">
                        ← Back to Home
                    </button>
                    <button onclick="showOrder()"
                            class="px-6 py-2 text-base font-semibold text-white rounded-full transition duration-300 shadow-md ${buttonClass} shadow-lg">
                        Order Now
                    </button>
                </div>
            `;
            return `
                <div class="w-full max-w-4xl animate-fadeIn">
                    <div class="p-4 sm:p-8 bg-white rounded-2xl shadow-2xl border ${themeClass} transition duration-300">
                        ${menuContent}
                    </div>
                </div>
            `;
        }
        
        function renderSuccess() {
            APP_ROOT.classList.add('justify-center');
            
            // Reverting to the simple confirmation page requested previously
            const details = state.lastOrderDetails || {};
            const orderIdDisplay = details.order_id ? `<p class="text-sm text-gray-400 mb-4">Order ID: ${details.order_id}</p>` : '';

            return `
                <div class="text-center animate-fadeIn w-full max-w-xl flex flex-col items-center bg-white p-10 rounded-2xl shadow-2xl border border-gray-100">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Order Sent!</h2>
                    ${orderIdDisplay}
                    <p class="text-lg text-gray-600 mb-8 leading-relaxed">
                        Please expect a call from us before 6pm to confirm your order. Thank you.
                    </p>
                    
                    <button onclick="showLanding()" class="px-6 py-2 bg-purple-oven text-white font-medium rounded-full hover:bg-indigo-700 transition duration-300">
                        Return to Home
                    </button>
                </div>
            `;
        }

        // --- Form Functions ---

        function toggleQuantity(checkbox) {
            const qtyInputId = `qty_${checkbox.id}`;
            const qtyInput = document.getElementById(qtyInputId);
            if (qtyInput) {
                qtyInput.disabled = !checkbox.checked;
                if (checkbox.checked) {
                    qtyInput.focus();
                    qtyInput.value = '1';
                } else {
                    qtyInput.value = '';
                }
            }
        }
        
        function handleOrderTypeChange(type) {
            const pickupSelect = document.getElementById('pickupSelect');
            const deliveryNoticeContainer = document.getElementById('deliveryNoticeContainer');
            const deliveryInput = document.getElementById('deliveryInput');
            const landmarkInput = document.getElementById('landmarkInput');
            const locationLabel = document.getElementById('locationLabel');
            const giftSection = document.getElementById('giftSection');

            if (type === 'Pick Up') {
                pickupSelect.classList.remove('hidden');
                pickupSelect.required = true;
                
                deliveryNoticeContainer.classList.add('hidden');
                
                deliveryInput.classList.add('hidden');
                deliveryInput.required = false;
                landmarkInput.classList.add('hidden');
                giftSection.classList.add('hidden');
                
                locationLabel.innerText = 'Store Location *';
                deliveryInput.value = ''; 
            } else {
                pickupSelect.classList.add('hidden');
                pickupSelect.required = false;
                
                deliveryNoticeContainer.classList.remove('hidden');
                
                deliveryInput.classList.remove('hidden');
                deliveryInput.required = true;
                landmarkInput.classList.remove('hidden');
                giftSection.classList.remove('hidden');
                
                locationLabel.innerText = 'Delivery Address *';
                pickupSelect.selectedIndex = 0; 
            }
        }

        function toggleGiftFields(checkbox) {
            const recipientFields = document.getElementById('recipientFields');
            const nameInput = recipientFields.querySelector('input[name="recipientName"]');
            const mobileInput = recipientFields.querySelector('input[name="recipientMobile"]');

            if (checkbox.checked) {
                recipientFields.classList.remove('hidden');
                nameInput.required = true;
                mobileInput.required = true;
            } else {
                recipientFields.classList.add('hidden');
                nameInput.required = false;
                mobileInput.required = false;
                nameInput.value = '';
                mobileInput.value = '';
            }
        }

        // Generate a unique ID based on timestamp (better than localStorage for web)
        function getNextOrderNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const randomSuffix = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            // Format: YYYYMMDD-RAND
            return `${year}${mm}${dd}-${randomSuffix}`;
        }
        
        function checkItemSelection() {
             const checkboxes = document.querySelectorAll('input[name="orderItem"]:checked');
             let selectedCount = 0;

             checkboxes.forEach(cb => {
                const qtyInputId = `qty_${cb.id}`;
                const qtyVal = parseInt(document.getElementById(qtyInputId).value || '0');
                if (qtyVal > 0) {
                    selectedCount++;
                }
            });
            return selectedCount;
        }

        function renderPurpleOvenMenuSelection() {
            let html = '';
            html += `<p class="text-sm text-gray-500 mb-4 bg-gray-50 p-3 rounded border border-gray-100">Check the items you want to order and input the desired quantity. Click on category headers to expand/collapse.</p>`;
            html += `<div id="itemErrorContainer" class="mb-4 text-red-500 text-sm font-semibold"></div>`;

            const renderItemFields = (items, catIndex, subCatIndex) => {
                return items.map((item, itemIndex) => {
                    const itemId = `item_${catIndex}_${subCatIndex}_${itemIndex}`;
                    
                    const parts = item.name.split(" - ");
                    let itemName = parts[0];
                    let itemUnit = parts.length > 1 ? parts.slice(1).join(" - ") : "";

                    return `<div class="grid grid-cols-[20px_1fr_48px_70px] sm:grid-cols-[20px_1fr_48px_100px] gap-2 sm:gap-4 items-center py-2 border-b border-gray-50 last:border-0">
                                <!-- Checkbox -->
                                <div class="flex items-center justify-center h-full">
                                    <input type="checkbox" id="${itemId}" name="orderItem" value="${item.name}" 
                                        onchange="toggleQuantity(this)"
                                        class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500 cursor-pointer border-gray-300">
                                </div>
                                
                                <!-- Name -->
                                <label for="${itemId}" class="text-sm text-gray-700 font-medium cursor-pointer leading-tight select-none">
                                    ${itemName}
                                </label>
                                
                                <!-- Qty -->
                                <div>
                                    <input type="number" id="qty_${itemId}" name="itemQty" min="1" placeholder="0" disabled
                                        class="w-full text-center border border-gray-300 rounded px-1 py-1 text-sm focus:outline-none focus:border-purple-500 disabled:bg-gray-100 disabled:text-gray-400">
                                </div>
                                
                                <!-- Unit -->
                                <div class="text-xs text-gray-400 text-right pr-2">
                                    ${itemUnit}
                                </div>
                            </div>`;
                }).join('');
            };

            purpleOvenMenuData.forEach((category, catIndex) => {
                // Using Details/Summary for Collapsible - DEFAULT CLOSED (No 'open' attribute)
                html += `<div class="mb-4 border border-gray-200 rounded-lg overflow-hidden">`;
                html += `
                    <details class="group">
                        <summary class="flex justify-between items-center cursor-pointer p-4 bg-gray-50 hover:bg-purple-50 transition-colors">
                            <h3 class="text-lg font-bold text-purple-oven">${category.category}</h3>
                            <span class="summary-icon text-purple-oven transform transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </span>
                        </summary>
                        <div class="p-4 bg-white border-t border-gray-100 animate-fadeIn">
                `;
                
                category.subCategories.forEach((subCat, subCatIndex) => {
                    // Logic for Nested Collapsibles (Cakes, Breads, etc. that have subcat names)
                    if (subCat.name) {
                        html += `
                            <details class="group/sub mb-2 last:mb-0">
                                <summary class="flex items-center cursor-pointer py-2 px-2 hover:bg-gray-50 rounded select-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 mr-2 transform transition-transform duration-200 summary-icon" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    <h4 class="text-md font-semibold text-gray-700">${subCat.name}</h4>
                                </summary>
                                <div class="pl-4 sm:pl-6 pb-2 border-l border-gray-100 ml-2">
                                    ${renderItemFields(subCat.items, catIndex, subCatIndex)}
                                </div>
                            </details>
                        `;
                    } else {
                        // For categories without sub-names (Bars, Cookies), just render the list
                        html += `<div class="pl-0 sm:pl-2">`;
                        html += renderItemFields(subCat.items, catIndex, subCatIndex);
                        html += `</div>`;
                    }
                });

                html += `</div></details></div>`;
            });

            return html;
        }

        function renderOrderForm() {
            APP_ROOT.classList.remove('justify-center');
            
            // Cleaned up header to match the white aesthetics of the original snippet
            const formHtml = `
                <div class="w-full max-w-4xl animate-fadeIn">
                    <form id="orderForm" onsubmit="submitOrder(event)" class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
                        
                        <!-- Header (Clean Style) -->
                        <div class="p-8 pb-4 text-center border-b border-gray-100">
                             <img src="${PO_LOGO_URL}" onerror="this.src='https://placehold.co/300x100/5D3FD3/fff?text=Purple+Oven'"
                                alt="Purple Oven Logo" class="mx-auto h-24 w-auto object-contain mb-4">
                            <h2 class="text-2xl font-bold text-purple-oven">How to Order</h2>
                            <button type="button" onclick="showMenu('PurpleOven')" class="mt-4 text-sm text-gray-500 hover:text-purple-600 transition underline">
                                ← Back to Menu
                            </button>
                        </div>

                        <!-- Office Hours & Methods -->
                        <div class="bg-purple-50 p-6 sm:p-8 border-b border-purple-100">
                            <h3 class="text-lg font-bold text-purple-900 mb-2">Office Hours</h3>
                            <p class="text-gray-700 text-sm mb-6">Our team is available to assist you with, receive, and facilitate your order daily from 9AM to 6PM.</p>
                            
                            <div class="flex flex-col gap-6">
                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm w-full">
                                    <h4 class="font-bold text-purple-800 mb-2">Option 1: Call Us</h4>
                                    <p class="text-sm text-gray-600 mb-3">For orders today, please give us a call.</p>
                                    <div class="space-y-1 text-sm font-medium">
                                        <p>
                                            <span class="text-gray-500">Landline:</span> 
                                            <!-- Enhanced link style for clarity -->
                                            <a href="tel:+63286314221" class="text-purple-700 font-bold hover:underline bg-purple-100/50 p-1 rounded-md transition-colors inline-block">
                                                +632 8631 4221
                                            </a>
                                        </p>
                                        <p>
                                            <span class="text-gray-500">Mobile / Viber:</span> 
                                            <!-- Enhanced link style for clarity -->
                                            <a href="tel:+639177103227" class="text-purple-700 font-bold hover:underline bg-purple-100/50 p-1 rounded-md transition-colors inline-block">
                                                +63917 710 3227
                                            </a>
                                        </p>
                                    </div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm w-full">
                                    <h4 class="font-bold text-purple-800 mb-2">Option 2: Order Online</h4>
                                    <p class="text-sm text-gray-600">For orders tomorrow and onwards, please provide us with the details below. We will contact you as soon as we can confirm your order.</p>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 sm:p-10 space-y-8">
                            
                            <!-- Customer Details -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-bold text-gray-800 border-b pb-2">Customer Details</h3>
                                <!-- Removed customerSocial input field (Facebook/Instagram) -->
                                <div class="form-grid">
                                    <div class="flex flex-col">
                                        <label class="text-sm font-semibold text-gray-600 mb-1">Full Name *</label>
                                        <input type="text" name="customerName" required class="p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-sm font-semibold text-gray-600 mb-1">Mobile Number *</label>
                                        <input type="tel" name="customerMobile" required class="p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-sm font-semibold text-gray-600 mb-1">Email Address *</label>
                                        <input type="email" name="customerEmail" required class="p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                                    </div>
                                    
                                </div>
                            </div>

                            <!-- Order Details -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-bold text-gray-800 border-b pb-2">Order Details</h3>
                                
                                <div class="flex gap-6 mb-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="orderType" value="Pick Up" checked onchange="handleOrderTypeChange('Pick Up')" class="text-purple-600 focus:ring-purple-500 h-5 w-5">
                                        <span class="font-medium">Pick Up</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="orderType" value="Delivery" onchange="handleOrderTypeChange('Delivery')" class="text-purple-600 focus:ring-purple-500 h-5 w-5">
                                        <span class="font-medium">Delivery</span>
                                    </label>
                                </div>

                                <!-- Delivery Notice -->
                                <div id="deliveryNoticeContainer" class="notice-box p-4 hidden">
                                    <p class="text-sm text-gray-700">
                                        <strong>Note:</strong> We can arrange for delivery to your home, within Metro Manila. Please provide the delivery details below.
                                    </p>
                                </div>

                                <div class="space-y-4">
                                    <div class="flex flex-col">
                                        <label id="locationLabel" class="text-sm font-semibold text-gray-600 mb-1">Store Location *</label>
                                        
                                        <!-- Pickup Select -->
                                        <select id="pickupSelect" name="pickupLocation" required class="p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none bg-white">
                                            <option value="" disabled selected>Select a branch...</option>
                                            ${pickUpLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                                        </select>

                                        <!-- Delivery Input -->
                                        <input type="text" id="deliveryInput" name="deliveryAddress" placeholder="Enter complete delivery address" class="hidden p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                                    </div>
                                    
                                    <div class="flex flex-col">
                                        <input type="text" id="landmarkInput" name="landmark" placeholder="Nearest Landmark" class="hidden p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none mt-2">
                                    </div>
                                </div>

                                <div class="form-grid mt-4">
                                    <div class="flex flex-col">
                                        <label class="text-sm font-semibold text-gray-600 mb-1">Date *</label>
                                        <!-- Changed type to 'text' for Flatpickr, removed inline validtion since Flatpickr handles it visually -->
                                        <input type="text" id="datePicker" name="orderDate" required placeholder="Select Order Date..." class="p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none bg-white">
                                        <p class="text-xs text-gray-500 mt-1">Ordering available from tomorrow up to 1 year.</p>
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-sm font-semibold text-gray-600 mb-1">Time *</label>
                                        <select name="orderTime" required class="p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none bg-white">
                                            <option value="" disabled selected>Select time...</option>
                                            ${timeSlots.map(t => `<option value="${t}">${t}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Gift Section -->
                            <div id="giftSection" class="hidden p-4 option-box">
                                <label class="flex items-center gap-2 mb-4 cursor-pointer">
                                    <input type="checkbox" name="isGift" onchange="toggleGiftFields(this)" class="rounded text-purple-600 focus:ring-purple-500 h-5 w-5">
                                    <span class="font-bold text-purple-900">Is this a gift?</span>
                                </label>
                                
                                <div id="recipientFields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 animate-fadeIn">
                                    <div class="flex flex-col">
                                        <label class="text-sm font-semibold text-gray-600 mb-1">Recipient Name *</label>
                                        <input type="text" name="recipientName" class="p-2 border rounded focus:ring-2 focus:ring-purple-500 outline-none">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-sm font-semibold text-gray-600 mb-1">Recipient Mobile *</label>
                                        <input type="tel" name="recipientMobile" class="p-2 border rounded focus:ring-2 focus:ring-purple-500 outline-none">
                                    </div>
                                    <div class="col-span-1 md:col-span-2 flex flex-col">
                                        <label class="text-sm font-semibold text-gray-600 mb-1">Dedication / Note</label>
                                        <textarea name="dedication" rows="2" class="p-2 border rounded focus:ring-2 focus:ring-purple-500 outline-none"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Menu Items -->
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Select Items</h3>
                                ${renderPurpleOvenMenuSelection()}
                            </div>

                            <!-- Important Notice -->
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <p class="text-yellow-800 font-bold text-sm mb-1">Important Notice:</p>
                                <p class="text-sm text-yellow-800 leading-relaxed">
                                    As we bake in limited quantities daily, please allow us to check the availability of your order. 
                                    <span class="font-extrabold">We shall call you as soon as we can confirm your order.</span>
                                </p>
                            </div>

                            <!-- Submit -->
                             <div class="pt-2 border-t border-gray-100 flex flex-col gap-4">
                                <button type="submit" id="submitBtn" class="w-full py-4 bg-purple-oven text-white font-bold text-xl rounded-xl hover:bg-indigo-800 transition shadow-lg flex justify-center items-center gap-2">
                                    Submit Order
                                </button>
                            </div>

                        </div>
                    </form>
                </div>

                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
                    <div class="bg-white p-6 rounded-xl flex flex-col items-center shadow-2xl">
                        <div class="spinner border-purple-600 border-t-transparent w-10 h-10 mb-4"></div>
                        <p class="font-semibold text-gray-700">Sending Order...</p>
                    </div>
                </div>
            `;
            
            APP_ROOT.innerHTML = formHtml;

            // Initialize Flatpickr Logic immediately after HTML insertion
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);

            flatpickr("#datePicker", {
                minDate: tomorrow,
                maxDate: nextYear,
                dateFormat: "Y-m-d",
                disable: [
                    function(date) {
                        const m = date.getMonth(); // 0-11
                        const d = date.getDate();
                        const y = date.getFullYear();

                        // Every Year: Dec 25 (Month 11) & Jan 1 (Month 0)
                        if (m === 11 && d === 25) return true;
                        if (m === 0 && d === 1) return true;

                        // 2026 Specific: April 2 & 3 (Holy Week)
                        if (y === 2026 && m === 3 && (d === 2 || d === 3)) return true;

                        return false;
                    }
                ]
            });
        }

        function render() {
            if (state.view === 'landing') {
                APP_ROOT.innerHTML = renderLanding();
            } else if (state.view === 'menu') {
                APP_ROOT.innerHTML = renderMenu(state.selectedBrand);
            } else if (state.view === 'order_form') {
                renderOrderForm();
            } else if (state.view === 'success') {
                renderSuccess();
            }
        }
        
        async function submitOrder(e) {
            e.preventDefault();
            
            if (state.isSubmitting) return;

            // 1. Validation
            const selectedItemsCount = checkItemSelection();
            if (selectedItemsCount === 0) {
                const errorContainer = document.getElementById('itemErrorContainer');
                errorContainer.innerText = "⚠️ Please select at least one item to order.";
                errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            } else {
                document.getElementById('itemErrorContainer').innerText = "";
            }

            // 2. Gather Data
            const form = e.target;
            const formData = new FormData(form);
            
            // Build Item List String
            let orderSummary = "";
            const checkboxes = form.querySelectorAll('input[name="orderItem"]:checked');
            checkboxes.forEach(cb => {
                const qtyInputId = `qty_${cb.id}`;
                const qty = document.getElementById(qtyInputId).value;
                const name = cb.value;
                orderSummary += `• ${qty} x ${name}\n`;
            });

            const orderId = getNextOrderNumber();
            const orderType = formData.get('orderType');
            const location = orderType === 'Pick Up' ? formData.get('pickupLocation') : formData.get('deliveryAddress') + (formData.get('landmark') ? ` (Landmark: ${formData.get('landmark')})` : '');
            
            const templateParams = {
                order_id: orderId,
                customer_name: formData.get('customerName'),
                customer_email: formData.get('customerEmail'),
                customer_mobile: formData.get('customerMobile'),
                order_type: orderType,
                location_address: location,
                order_date: formData.get('orderDate'),
                order_time: formData.get('orderTime'),
                is_gift: formData.get('isGift') ? 'YES' : 'NO',
                recipient_details: formData.get('isGift') ? 
                    `Name: ${formData.get('recipientName')}\nMobile: ${formData.get('recipientMobile')}\nNote: ${formData.get('dedication')}` : 'N/A',
                order_summary: orderSummary
            };

            // 3. Save details and Send Email
            state.lastOrderDetails = templateParams; // Save details for the success page
            state.isSubmitting = true;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = true;

            try {
                // NOTE: We are using window.emailjs global
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                
                showSuccess(); // Show clean success screen

            } catch (error) {
                console.error('FAILED...', error);
                alert("Failed to send order. Please try again or contact us directly.");
            } finally {
                state.isSubmitting = false;
                // Elements might be gone if we switched view, so check existence
                const loading = document.getElementById('loadingOverlay');
                if(loading) loading.classList.add('hidden');
                const btn = document.getElementById('submitBtn');
                if(btn) btn.disabled = false;
            }
        }

        // --- Init ---
        // FIX: Wrap the initial render call in an IIFE to ensure all function definitions 
        // in the large script block are processed first, resolving the ReferenceError.
        (function() {
            render();
        })();

    </script>
</body>
</html>
